--
--create nested table type
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var type_aa;
begin
	null;
end;
/
--
--not support multiple elements
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of (id int, flg char);
	var type_aa;
begin
	null;
end;
/
ERROR:  syntax error at or near "("
LINE 3:  type type_aa is table of (id int, flg char);
                                  ^
QUERY:  
declare
	type type_aa is table of (id int, flg char);
	var type_aa;
begin
	null;
end;
CONTEXT:  invalid type name "(id int, flg char)"
--
--assign value to nested table variable
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var type_aa;
begin
	var := type_aa(11, 22, 33, 44, 55);
	raise notice 'var = %', var;
	raise notice 'var(5) = %', var(5);
end;
/
select nested_tab_func1();
NOTICE:  var = {11,22,33,44,55}
NOTICE:  var(5) = 55
 nested_tab_func1 
------------------
 
(1 row)

--
--nested table type and variable can declare anywhere
--
create or replace function nested_tab_func1() return void as
declare
	var1 int;
	type type_aa is table of int;
	var2 text;
	var3 type_aa := type_aa(11, 22, 33, 44, 55);
	var4 char;
begin
	raise notice 'var3(1) = %', var3(1);
	raise notice 'var3(5) = %', var3(5);
end;
/
select nested_tab_func1();
NOTICE:  var3(1) = 11
NOTICE:  var3(5) = 55
 nested_tab_func1 
------------------
 
(1 row)

--
--is not support assigned value to nested, must use construct function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var_aa type_aa;
begin
	var_aa := (11, 22, 33, 44, 55);
	raise notice '%', var_aa.id;
end;
/
select nested_tab_func1();
ERROR:  expression is of wrong type, [record] to [type_aa]
CONTEXT:  PL/hgSQL function nested_tab_func1() line 6 at assignment
--
--assign a value to nested table element
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var type_aa := type_aa(11, 22, 33, 44, 55);
begin
	var(1) := 66;
	var(5) := 77;
	raise notice 'var(1) = %', var(1);
	raise notice 'var(5) = %', var(5);
end;
/
select nested_tab_func1();
NOTICE:  var(1) = 66
NOTICE:  var(5) = 77
 nested_tab_func1 
------------------
 
(1 row)

--
--define multiple nested table
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is table of type_aa;
	var2 type_bb := type_bb(var1, type_aa(66, 77), type_aa(88));
begin
	raise notice 'var1 = %', var1;
	raise notice 'var1(2) = %', var1(2);
	raise notice 'var2 = %', var2;
	raise notice 'var2(1) = %', var2(1);
	raise notice 'var2(3) = %', var2(3);
	raise notice 'var2(1)(5) = %', var2(1)(5);
end;
/
select nested_tab_func1();
NOTICE:  var1 = {11,22,33,44,55}
NOTICE:  var1(2) = 22
NOTICE:  var2 = {"{11,22,33,44,55}","{66,77}","{88}"}
NOTICE:  var2(1) = {11,22,33,44,55}
NOTICE:  var2(3) = {88}
NOTICE:  var2(1)(5) = 55
 nested_tab_func1 
------------------
 
(1 row)

--
--construct function use error
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is table of type_aa;
	var2 type_bb := type_bb(var1, type_bb(66, 77), type_aa(88));
begin
	raise notice 'var1 = %', var1;
end;
/
select nested_tab_func1();
ERROR:  failed to find conversion function from integer to nestedtab
CONTEXT:  SQL statement "SELECT type_bb(var1, type_bb(66, 77), type_aa(88))"
PL/hgSQL function nested_tab_func1() line 7 during statement block local variable initialization
--
--subscript beyond range
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is table of type_aa;
	var2 type_bb := type_bb(var1, type_aa(66, 77), type_aa(88));
begin
	var2(2)(3) := 99;
	raise notice 'var2 = %', var2;
end;
/
select nested_tab_func1();
ERROR:  Subscript(3) outside of limit (2)
DETAIL:  An in-limit subscript was greater than the count of a varray or too large for a nested table.
CONTEXT:  PL/hgSQL function nested_tab_func1() line 8 at assignment
--
--same type assign value
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	var2 type_aa;
begin
	var1(5) := 66;
	var2 := var1;
	var2(1) := 77;
	raise notice 'var2 = %', var2;
	raise notice 'num = %', var2(1) + var1(3);
end;
/
select nested_tab_func1();
NOTICE:  var2 = {77,22,33,44,66}
NOTICE:  num = 110
 nested_tab_func1 
------------------
 
(1 row)

--
--delete function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	var1.delete(1);
	raise notice 'var1 = %', var1(1);
end;
/
select nested_tab_func1();
ERROR:  No data found
DETAIL:  There was no data from the varray or nested table which may be due to end of fetch
CONTEXT:  PL/hgSQL function nested_tab_func1() line 7 at RAISE
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	var1.delete(1, 5);
	raise notice 'var1 = %', var1;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {,,,,}
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	var1.delete(1);
	var1.delete(6); --do nothing
	raise notice 'var1 = %, %, %, %', var1(2), var1(3), var1(4), var1(5);
	raise notice 'var1 = %, %', var1(2), var1(1);
end;
/
select nested_tab_func1();
NOTICE:  var1 = 22, 33, 44, 55
ERROR:  No data found
DETAIL:  There was no data from the varray or nested table which may be due to end of fetch
CONTEXT:  PL/hgSQL function nested_tab_func1() line 9 at RAISE
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	var1.delete(1);
	raise notice 'var1 = %', var1(0);
end;
/
select nested_tab_func1();
NOTICE:  var1 = <NULL>
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	var1.delete(1);
	var1.delete(1);
	var1.delete(5);
	raise notice 'var1 = %', var1;
	var1(1) := 66;
	raise notice 'var1(1) = %', var1(1);
	raise notice 'var1 = %', var1;
	raise notice '%', var1(5);
end;
/
select nested_tab_func1();
NOTICE:  var1 = {,22,33,44,}
NOTICE:  var1(1) = 66
NOTICE:  var1 = {66,22,33,44,}
ERROR:  No data found
DETAIL:  There was no data from the varray or nested table which may be due to end of fetch
CONTEXT:  PL/hgSQL function nested_tab_func1() line 13 at RAISE
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	raise notice 'var1 = %', var1;
	var1.delete(1, 3);
	raise notice 'var1 = %', var1;
	var1.delete(-1, 4);
	raise notice 'var1 = %', var1;
	var1(1) := 66;
	raise notice 'var1(1) = %', var1(1);
	raise notice 'var1 = %', var1;
	var1.delete(1);
	raise notice 'var1 = %', var1;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {11,22,33,44,55}
NOTICE:  var1 = {,,,44,55}
NOTICE:  var1 = {,,,,55}
NOTICE:  var1(1) = 66
NOTICE:  var1 = {66,,,,55}
NOTICE:  var1 = {,,,,55}
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	raise notice 'var1 = %', var1;
	var1.delete(-1, 3);
	raise notice 'var1 = %', var1;
	var1.Delete();
	var1(1) := 66;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {11,22,33,44,55}
NOTICE:  var1 = {,,,44,55}
ERROR:  Subscript beyond count
DETAIL:  A subscript was greater than the limit of a varray or non-positive for a varray or nested table. the varry was deleted
CONTEXT:  PL/hgSQL function nested_tab_func1() line 10 at assignment
--varray array can not call delete function which have parameters
create or replace function nested_tab_func1() return void as
declare
	type type_aa is varray(10) of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	var1.delete(-1, 3);
end;
/
select nested_tab_func1();
ERROR:  procedure collection_delete(varray, integer, integer) does not exist
LINE 1: CALL var1.delete(-1, 3)
             ^
HINT:  No procedure matches the given name and argument types. You might need to add explicit type casts.
QUERY:  CALL var1.delete(-1, 3)
CONTEXT:  PL/hgSQL function nested_tab_func1() line 6 at CALL
create or replace function nested_tab_func1() return void as
declare
	type type_aa is varray(10) of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is varray(10) of type_aa;
	var2 type_bb := type_bb(var1);
	type type_cc is varray(10) of type_bb;
	var3 type_cc := type_cc(var2);
begin
	var3(1)(1).delete(1);
end;
/
select nested_tab_func1();
ERROR:  procedure "collection_delete" does not exist
CONTEXT:  SQL statement "CALL var3(1)(1).collection_delete(1)"
PL/hgSQL function nested_tab_func1() line 10 at CALL
--
--mix use delete function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is varray(10) of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	var2 type_aa := type_aa(66, 77);
	type type_bb is table of type_aa;
	var3 type_bb := type_bb(var1, var2, type_aa(88, 99));
	var4 int;
begin
	raise notice 'var3 = %', var3;
	var2.delete; -- varray function
	raise notice 'var3 = %', var3;
	raise notice 'var3(2)(1) = %', var3(2)(1);
	var3.delete(1); --nested table function
	raise notice 'var3 = %', var3;
	var4 := 10;
	var3(1) := type_aa(var4);
	raise notice 'var3(1) = %', var3(1);
	var3.delete(1, 2);
	raise notice 'var3 = %', var3;
end;
/
select nested_tab_func1();
NOTICE:  var3 = {"{11,22,33,44,55}","{66,77}","{88,99}"}
NOTICE:  var3 = {"{11,22,33,44,55}","{66,77}","{88,99}"}
NOTICE:  var3(2)(1) = 66
NOTICE:  var3 = {,"{66,77}","{88,99}"}
NOTICE:  var3(1) = {10}
NOTICE:  var3 = {,,"{88,99}"}
 nested_tab_func1 
------------------
 
(1 row)

--
--trim function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	raise notice 'var1 = %', var1;
	var1.trim;
	raise notice 'var1 = %', var1;
	var1.Delete(5); --element does not eixst, not throw error
end;
/
select nested_tab_func1();
NOTICE:  var1 = {11,22,33,44,55}
NOTICE:  var1 = {11,22,33,44}
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	var1.delete(1, 5);
	var1.trim;
	raise notice 'var1 = %', var1;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {,,,}
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	var1.delete(1);
	var1.trim;
	raise notice 'var1(1) = %', var1(1);
end;
/
select nested_tab_func1();
ERROR:  No data found
DETAIL:  There was no data from the varray or nested table which may be due to end of fetch
CONTEXT:  PL/hgSQL function nested_tab_func1() line 8 at RAISE
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	raise notice 'var1 = %', var1;
	var1.Delete(5); --keep placeholder
	raise notice 'var1 = %', var1;
	var1.trim(1);
	raise notice 'var1 = %', var1;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {11,22,33,44,55}
NOTICE:  var1 = {11,22,33,44,}
NOTICE:  var1 = {11,22,33,44}
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	var1.trim(0);
	raise notice 'var1 = %', var1;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {11,22,33,44,55}
 nested_tab_func1 
------------------
 
(1 row)

--parameter can not is negative
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	var1.trim(-1);
	raise notice 'var1 = %', var1;
end;
/
select nested_tab_func1();
ERROR:  Subscript beyond count
DETAIL:  A subscript was greater than the limit of a varray or non-positive for a varray or nested table. the varry was deleted
CONTEXT:  PL/hgSQL function collection_trim(nestedtab,integer) line 3 at assignment
SQL statement "CALL var1.trim(-1)"
PL/hgSQL function nested_tab_func1() line 6 at CALL
--after trim, can not restore it
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	raise notice 'var1 = %', var1;
	var1.trim(2);
	raise notice 'var1 = %', var1;
	var1(4) := 66;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {11,22,33,44,55}
NOTICE:  var1 = {11,22,33}
ERROR:  Subscript(4) outside of limit (3)
DETAIL:  An in-limit subscript was greater than the count of a varray or too large for a nested table.
CONTEXT:  PL/hgSQL function nested_tab_func1() line 9 at assignment
--delete all and trim it
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
begin
	raise notice 'var1 = %', var1;
	var1.delete;
	var1.trim;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {11,22,33,44,55}
ERROR:  Subscript beyond count
DETAIL:  A subscript was greater than the limit of a varray or non-positive for a varray or nested table. the varry was deleted
CONTEXT:  PL/hgSQL function collection_trim(nestedtab) line 3 at assignment
SQL statement "CALL var1.trim"
PL/hgSQL function nested_tab_func1() line 8 at CALL
--mix use varray and nested table
create or replace function nested_tab_func1() return void as
declare
	type type_aa is varray(10) of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is table of type_aa;
	var2 type_bb := type_bb(type_aa(66, 77), var1);
	type type_cc is table of type_bb;
	var3 type_cc := type_cc(var2, var2);
begin
	raise notice 'var1 = %', var1;
	raise notice 'var2 = %', var2;
	var1.trim;
	raise notice 'var2 = %', var2;
	var2(2).trim(1);
	raise notice 'var1 = %', var1;
	raise notice 'var2 = %', var2;
	var3(1)(1).trim;
	raise notice 'var3 = %', var3;
	var3(2).delete(2);
	raise notice 'var3 = %', var3;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {11,22,33,44,55}
NOTICE:  var2 = {"{66,77}","{11,22,33,44,55}"}
NOTICE:  var2 = {"{66,77}","{11,22,33,44,55}"}
NOTICE:  var1 = {11,22,33,44}
NOTICE:  var2 = {"{66,77}","{11,22,33,44}"}
NOTICE:  var3 = {"{\"{66}\",\"{11,22,33,44,55}\"}","{\"{66,77}\",\"{11,22,33,44,55}\"}"}
NOTICE:  var3 = {"{\"{66}\",\"{11,22,33,44,55}\"}","{\"{66,77}\",}"}
 nested_tab_func1 
------------------
 
(1 row)

--
--extend function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc');
begin
	raise notice 'var1 = %', var1;
	var1.extend;
	raise notice 'var1 = %', var1;
	raise notice 'var1(4) = %', var1(4);
	var1(3) := 'dd';
	var1(4) := 'ee';
	raise notice 'var1 = %', var1;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {aa,bb,cc}
NOTICE:  var1 = {aa,bb,cc,NULL}
NOTICE:  var1(4) = <NULL>
NOTICE:  var1 = {aa,bb,dd,ee}
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc');
begin
	var1.delete(1, 3);
	raise notice 'var1 = %', var1;
	var1.extend(2);
	raise notice 'var1 = %', var1;
	var1.delete(4, 5);
	raise notice 'var1 = %', var1;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {,,}
NOTICE:  var1 = {,,,NULL,NULL}
NOTICE:  var1 = {,,,,}
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc');
begin
	var1.delete(1, 3);
	var1.extend(1, 2);
end;
/
select nested_tab_func1();
ERROR:  No data found
DETAIL:  There was no data from the varray or nested table which may be due to end of fetch
CONTEXT:  PL/hgSQL function collection_extend(nestedtab,integer,integer) line 3 at assignment
SQL statement "CALL var1.extend(1, 2)"
PL/hgSQL function nested_tab_func1() line 7 at CALL
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc');
begin
	var1.extend(1, 4);
end;
/
select nested_tab_func1();
ERROR:  Subscript beyond count
DETAIL:  A subscript was greater than the limit of a varray or non-positive for a varray or nested table. the varry was deleted
CONTEXT:  PL/hgSQL function collection_extend(nestedtab,integer,integer) line 3 at assignment
SQL statement "CALL var1.extend(1, 4)"
PL/hgSQL function nested_tab_func1() line 6 at CALL
--mix use extend, delete and trim function
create or replace procedure nested_tab_proc1() as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc');
begin
	raise notice 'var1 = %', var1;
	var1.extend;
	raise notice 'var1 = %', var1;
	var1.delete(4);
	raise notice 'var1 = %', var1;
	var1.trim(1);
	raise notice 'var1 = %', var1;
	var1.extend(2);
	raise notice 'var1 = %', var1;
	var1(5) := 'dd';
	raise notice 'var1 = %', var1;
	var1.extend(2, 5);
	raise notice 'var1 = %', var1;
	var1.delete(7, 7);
	raise notice 'var1 = %', var1;
end;
/
call nested_tab_proc1();
NOTICE:  var1 = {aa,bb,cc}
NOTICE:  var1 = {aa,bb,cc,NULL}
NOTICE:  var1 = {aa,bb,cc,}
NOTICE:  var1 = {aa,bb,cc}
NOTICE:  var1 = {aa,bb,cc,NULL,NULL}
NOTICE:  var1 = {aa,bb,cc,NULL,dd}
NOTICE:  var1 = {aa,bb,cc,NULL,dd,dd,dd}
NOTICE:  var1 = {aa,bb,cc,NULL,dd,dd,}
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc');
begin
	var1.extend(2, 0);
end;
/
select nested_tab_func1();
ERROR:  Subscript beyond count
DETAIL:  A subscript was greater than the limit of a varray or non-positive for a varray or nested table. the varry was deleted
CONTEXT:  PL/hgSQL function collection_extend(nestedtab,integer,integer) line 3 at assignment
SQL statement "CALL var1.extend(2, 0)"
PL/hgSQL function nested_tab_func1() line 6 at CALL
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc');
begin
	var1.extend(0);
	raise notice 'var1 = %', var1;
	var1.extend(-1);
end;
/
select nested_tab_func1();
NOTICE:  var1 = {aa,bb,cc}
ERROR:  Subscript beyond count
DETAIL:  A subscript was greater than the limit of a varray or non-positive for a varray or nested table. the varry was deleted
CONTEXT:  PL/hgSQL function collection_extend(nestedtab,integer) line 3 at assignment
SQL statement "CALL var1.extend(-1)"
PL/hgSQL function nested_tab_func1() line 8 at CALL
--mix use varray and nested table
create or replace function nested_tab_func1() return void as
declare
	type type_aa is varray(10) of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is table of type_aa;
	var2 type_bb := type_bb(type_aa(66, 77), var1);
	type type_cc is table of type_bb;
	var3 type_cc := type_cc(var2, var2);
begin
	raise notice 'var1 = %', var1;
	raise notice 'var2 = %', var2;
	var1.extend(2);
	var3.extend();
	var3(3) := type_bb(var1);
	raise notice 'var3 = %', var3;
	var3(1)(1).extend(1, 1);
	raise notice 'var3 = %', var3;
	var3(1).extend(1);
	raise notice 'var3 = %', var3;
	var3(1)(1).trim(1);
	raise notice 'var3 = %', var3;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {11,22,33,44,55}
NOTICE:  var2 = {"{66,77}","{11,22,33,44,55}"}
NOTICE:  var3 = {"{\"{66,77}\",\"{11,22,33,44,55}\"}","{\"{66,77}\",\"{11,22,33,44,55}\"}","{\"{11,22,33,44,55,NULL,NULL}\"}"}
NOTICE:  var3 = {"{\"{66,77,66}\",\"{11,22,33,44,55}\"}","{\"{66,77}\",\"{11,22,33,44,55}\"}","{\"{11,22,33,44,55,NULL,NULL}\"}"}
NOTICE:  var3 = {"{\"{66,77,66}\",\"{11,22,33,44,55}\",NULL}","{\"{66,77}\",\"{11,22,33,44,55}\"}","{\"{11,22,33,44,55,NULL,NULL}\"}"}
NOTICE:  var3 = {"{\"{66,77}\",\"{11,22,33,44,55}\",NULL}","{\"{66,77}\",\"{11,22,33,44,55}\"}","{\"{11,22,33,44,55,NULL,NULL}\"}"}
 nested_tab_func1 
------------------
 
(1 row)

--
--exists function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc');
begin
	raise notice 'var1(1) = %, var1(4) = %', var1.exists(1), var1.exists(4);
	raise notice 'var1(0) = %, var1(-1) = %', var1.exists(0), var1.exists(-1);
end;
/
select nested_tab_func1();
NOTICE:  var1(1) = t, var1(4) = f
NOTICE:  var1(0) = f, var1(-1) = f
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc');
begin
	raise notice 'var1(4) = %', var1.exists(4);

	var1.extend(2);
	if var1.exists(4) then
		raise notice 'var1.exists(4) exists';
	else
		raise notice 'var1.exists(4) not exists';
	end if;

	var1.delete(3);
	if var1.exists(3) = 't' then
		raise notice 'var1.exists(3) exists';
	else
		raise notice 'var1.exists(3) not exists';
	end if;

	var1.trim(3);
	if var1.exists(2) then
		raise notice 'var1.exists(2) exists';
	else
		raise notice 'var1.exists(2) not exists';
	end if;

	if var1.exists(3) then
		raise notice 'var1.exists(3) exists';
	else
		raise notice 'var1.exists(3) not exists';
	end if;

	var1.delete();
	raise notice 'var1(1) = %', var1.exists(1);
end;
/
select nested_tab_func1();
NOTICE:  var1(4) = f
NOTICE:  var1.exists(4) exists
NOTICE:  var1.exists(3) not exists
NOTICE:  var1.exists(2) exists
NOTICE:  var1.exists(3) not exists
NOTICE:  var1(1) = f
 nested_tab_func1 
------------------
 
(1 row)

--mix use varray and nested table
create or replace function nested_tab_func1() return void as
declare
	type type_aa is varray(10) of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is table of type_aa;
	var2 type_bb := type_bb(type_aa(66, 77), var1);
	type type_cc is table of type_bb;
	var3 type_cc := type_cc(var2, var2);
begin
	raise notice 'var3(2)(2) = %', var3(2).exists(2);
	var3(2).delete(2);
	raise notice 'var3(2)(2) = %', var3(2).exists(2);
	raise notice 'var3(2)(1)(3) = %', var3(2)(1).exists(3);
	var3(2)(1).extend;
	raise notice 'var3(2)(1)(3) = %', var3(2)(1).exists(3);
end;
/
select nested_tab_func1();
NOTICE:  var3(2)(2) = t
NOTICE:  var3(2)(2) = f
NOTICE:  var3(2)(1)(3) = f
NOTICE:  var3(2)(1)(3) = t
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func2() return bool as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc', 'dd', 'ee');
begin
	var1.delete(1, 5);
	return var1.exists(5);
end;
/
select nested_tab_func2();
 nested_tab_func2 
------------------
 f
(1 row)

--
--first and last function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc', 'dd', 'ee');
begin
	raise notice 'var1.first = %', var1.first;
	raise notice 'var1.last = %', var1.last;
	var1.delete(1);
	var1.delete(4, 5);
	raise notice 'var1.first = %', var1.first;
	raise notice 'var1.last = %', var1.last;
end;
/
select nested_tab_func1();
NOTICE:  var1.first = 1
NOTICE:  var1.last = 5
NOTICE:  var1.first = 2
NOTICE:  var1.last = 3
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc', 'dd', 'ee');
begin
	raise notice 'var1.first = %', var1.first;
	raise notice 'var1.last = %', var1.last;
	var1.delete(1);
	var1.delete(4, 5);
	var1.extend();
	raise notice 'var1.first = %', var1.first;
	raise notice 'var1.last = %', var1.last;
	var1.trim(4);
	raise notice 'var1.first = %', var1.first;
	raise notice 'var1.last = %', var1.last;
	var1.delete();
	raise notice 'var1.first = %', var1.first;
	raise notice 'var1.last = %', var1.last;
	var1.extend(2);
	raise notice 'var1.first = %', var1.first;
	raise notice 'var1.last = %', var1.last;
	raise notice 'var1 = %', var1;
end;
/
select nested_tab_func1();
NOTICE:  var1.first = 1
NOTICE:  var1.last = 5
NOTICE:  var1.first = 2
NOTICE:  var1.last = 6
NOTICE:  var1.first = 2
NOTICE:  var1.last = 2
NOTICE:  var1.first = <NULL>
NOTICE:  var1.last = <NULL>
NOTICE:  var1.first = 1
NOTICE:  var1.last = 2
NOTICE:  var1 = {NULL,NULL}
 nested_tab_func1 
------------------
 
(1 row)

--mix use varray and nested table
create or replace function nested_tab_func1() return void as
declare
	type type_aa is varray(10) of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is table of type_aa;
	var2 type_bb := type_bb(type_aa(66, 77), var1);
	type type_cc is table of type_bb;
	var3 type_cc := type_cc(var2, var2);
	var4 type_aa;
begin
	raise notice 'var3(1)(2).first = %', var3(1)(2).first(); --1
	raise notice 'var3(1)(2).last = %', var3(1)(2).last(); --5
	var3(1)(1).delete;
	raise notice 'var3(1)(1).first = %', var3(1)(1).first(); --NULL
	raise notice 'var3(1)(1).last = %', var3(1)(1).last(); --NULL
	var4 := type_aa(88, 99, 100);
	var3(1)(1) := var4;
	raise notice 'var3(1)(1)(3) = %', var3(1)(1)(3);
	var3(1).delete(1, 2);
	raise notice 'var3(1).first = %', var3(1).first;
	raise notice 'var3(1).last = %', var3(1).last;
end;
/
select nested_tab_func1();
NOTICE:  var3(1)(2).first = 1
NOTICE:  var3(1)(2).last = 5
NOTICE:  var3(1)(1).first = <NULL>
NOTICE:  var3(1)(1).last = <NULL>
NOTICE:  var3(1)(1)(3) = 100
NOTICE:  var3(1).first = <NULL>
NOTICE:  var3(1).last = <NULL>
 nested_tab_func1 
------------------
 
(1 row)

--
--count function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc', 'dd', 'ee');
begin
	raise notice 'var1.count = %', var1.count; --5
	var1.delete(1);
	raise notice 'var1 = %', var1;
	raise notice 'var1.count = %', var1.count;
	var1.delete(1, 5);
	raise notice 'var1.count = %', var1.count; --0
	var1.trim();
	raise notice 'var1.count = %', var1.count; --0
	var1.extend(3);
	raise notice 'var1 = %', var1;
	raise notice 'var1.count = %', var1.count; --3
	var1.delete(6, 7);
	raise notice 'var1.count = %', var1.count; --1
	var1.delete;
	raise notice 'var1.count = %', var1.count; --0
end;
/
select nested_tab_func1();
NOTICE:  var1.count = 5
NOTICE:  var1 = {,bb,cc,dd,ee}
NOTICE:  var1.count = 4
NOTICE:  var1.count = 0
NOTICE:  var1.count = 0
NOTICE:  var1 = {,,,,NULL,NULL,NULL}
NOTICE:  var1.count = 3
NOTICE:  var1.count = 1
NOTICE:  var1.count = 0
 nested_tab_func1 
------------------
 
(1 row)

--mix use varray and nested table
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is table of type_aa;
	var2 type_bb := type_bb(type_aa(66, 77), var1);
	type type_cc is varray(10) of type_bb;
	var3 type_cc := type_cc(var2, var2);
begin
	raise notice 'var1.count = %', var1.count(); --5
	raise notice 'var2.count = %', var2.count(); --2
	raise notice 'var3.count = %', var3.count(); --2

	if var2.count = var2.last then
		raise notice 'var2.count equal var2.last';
	else
		raise notice 'var2.count not equal var2.last';
	end if;

	var3(1).delete(1);
	raise notice 'var3(1).count = %', var3(1).count; --1
	var2(1).trim(2);
	raise notice 'var2(1).count = %', var2(1).count; --0
	var3(1).extend(2, 2);
	raise notice 'var3(1).count = %', var3(1).count; --3
end;
/
select nested_tab_func1();
NOTICE:  var1.count = 5
NOTICE:  var2.count = 2
NOTICE:  var3.count = 2
NOTICE:  var2.count equal var2.last
NOTICE:  var3(1).count = 1
NOTICE:  var2(1).count = 0
NOTICE:  var3(1).count = 3
 nested_tab_func1 
------------------
 
(1 row)

--
--limit function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc', 'dd', 'ee');
begin
	raise notice 'var1.limit = %', var1.limit;
	var1.delete(1, 5);
	raise notice 'var1.limit = %', var1.limit;
	var1.delete();
	raise notice 'var1.limit = %', var1.limit;
end;
/
select nested_tab_func1();
NOTICE:  var1.limit = <NULL>
NOTICE:  var1.limit = <NULL>
NOTICE:  var1.limit = <NULL>
 nested_tab_func1 
------------------
 
(1 row)

--mix use varray and nested table
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is table of type_aa;
	var2 type_bb := type_bb(type_aa(66, 77), var1);
	type type_cc is varray(10) of type_bb;
	var3 type_cc := type_cc(var2, var2);
begin
	raise notice 'var2.limit = %', var2.limit; --NULL
	raise notice 'var3.limit = %', var3.limit; --10
	raise notice 'var3(1)(2).limit = %', var3(1)(2).limit; --NULL

	if var3(1).limit is null then
		raise notice 'var3(1).limit is null';
	else
		raise notice 'var3(1).limit is not null';
	end if;

	var3(1)(1).extend(1, 2);
	raise notice 'var3(1)(1).limit = %', var3(1)(1).limit; --NULL
end;
/
select nested_tab_func1();
NOTICE:  var2.limit = <NULL>
NOTICE:  var3.limit = 10
NOTICE:  var3(1)(2).limit = <NULL>
NOTICE:  var3(1).limit is null
NOTICE:  var3(1)(1).limit = <NULL>
 nested_tab_func1 
------------------
 
(1 row)

--
--prior and next function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc', 'dd', 'ee');
begin
	raise notice 'var1.prior(5) = %', var1.prior(var1.last); --4
	raise notice 'var1.prior(6) = %', var1.prior(6); --5
	raise notice 'var1.prior(6) = %', var1.prior(var1.first); --NULL
	var1.delete(1, 2);
	raise notice 'var1.prior(4) = %', var1.prior(4); --3
	raise notice 'var1.prior(3) = %', var1.prior(4 - 1); --NULL
	var1.delete(1, 5);
	var1.extend;
	raise notice 'var1.prior(6) = %', var1.prior(6); --NULL
	raise notice 'var1.prior(7) = %', var1.prior(7); --6
	var1.delete;
	raise notice 'var1.prior(7) = %', var1.prior(7); --NULL
	raise notice 'var1.prior(3) = %', var1.prior(3); --NULL
	var1.extend(2);
	raise notice 'var1.prior(3) = %', var1.prior(3); --2
	var1.trim(1);
	raise notice 'var1.prior(3) = %', var1.prior(3); --1
end;
/
select nested_tab_func1();
NOTICE:  var1.prior(5) = 4
NOTICE:  var1.prior(6) = 5
NOTICE:  var1.prior(6) = <NULL>
NOTICE:  var1.prior(4) = 3
NOTICE:  var1.prior(3) = <NULL>
NOTICE:  var1.prior(6) = <NULL>
NOTICE:  var1.prior(7) = 6
NOTICE:  var1.prior(7) = <NULL>
NOTICE:  var1.prior(3) = <NULL>
NOTICE:  var1.prior(3) = 2
NOTICE:  var1.prior(3) = 1
 nested_tab_func1 
------------------
 
(1 row)

create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of varchar(10);
	var1 type_aa := type_aa('aa', 'bb', 'cc', 'dd', 'ee');
begin
	raise notice 'var1.next(-1) = %', var1.next(-1); --1
	raise notice 'var1.next(1) = %', var1.next(1); --2
	raise notice 'var1.next(5) = %', var1.next(var1.last); --NULL
	var1.delete(3, 4);
	raise notice 'var1.next(0) = %', var1.next(0); --1
	raise notice 'var1.next(3) = %', var1.next(3); --5
	var1.delete(1);
	var1(3) := 'ff';
	raise notice 'var1.next(0) = %', var1.next(0); --2
	raise notice 'var1.next(2) = %', var1.next(2); --3
	var1.delete(1, 5);
	raise notice 'var1.next(-2) = %', var1.next(-2); --NULL
	raise notice 'var1.next(6) = %', var1.next(6); --NULL
	var1.extend(2);
	raise notice 'var1.next(3) = %', var1.next(3); --6
	var1.trim(1);
	raise notice 'var1.next(3) = %', var1.next(3); --6
end;
/
select nested_tab_func1();
NOTICE:  var1.next(-1) = 1
NOTICE:  var1.next(1) = 2
NOTICE:  var1.next(5) = <NULL>
NOTICE:  var1.next(0) = 1
NOTICE:  var1.next(3) = 5
NOTICE:  var1.next(0) = 2
NOTICE:  var1.next(2) = 3
NOTICE:  var1.next(-2) = <NULL>
NOTICE:  var1.next(6) = <NULL>
NOTICE:  var1.next(3) = 6
NOTICE:  var1.next(3) = 6
 nested_tab_func1 
------------------
 
(1 row)

--mix use varray and nested table
create table nestedtab_test(id int, flg int);
create or replace function nested_tab_func3() return int as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is table of type_aa;
	var2 type_bb := type_bb(type_aa(66, 77), var1);
	type type_cc is varray(10) of type_bb;
	var3 type_cc := type_cc(var2, var2);
	var4 int;
begin
	if var3.next(1) = var2(1).prior(3) then
		raise notice 'var3.next(1) equal var2(1).prior(3)';--y
	else
		raise notice 'var3.next(1) not equal var2(1).prior(3)';
	end if;

	var4 := var3(1)(1).last;
	insert into nestedtab_test values(var4, var2(2)(5)), (var3(1)(1)(2), var1(2)); --2, 55/77, 22
	update nestedtab_test set id = var3(2)(1)(1), flg = var1(3) where id = var2(2)(1) - 9; --66, 33/77, 22

	var3(1).trim;
	var2.delete(2);
	if var3(1).next(0) = var2.prior(4) then
		raise notice 'var3(1).next(0) equal var2(1).prior(3)';--y
	else
		raise notice 'var3(1).next(0) not equal var2.prior(4)';
	end if;

	var2.extend(1);
	var3.extend(1, 2);
	if var3.prior(5) = var2.next(1) then
		raise notice 'var3.prior(5) equal var2.next(1)';--y
	else
		raise notice 'var3.prior(5) not equal var2.next(1)';
	end if;

	return var3(3)(2).next(1) + var3(3)(2).prior(5); --6
end;
/
select nested_tab_func3();
NOTICE:  var3.next(1) equal var2(1).prior(3)
NOTICE:  var3(1).next(0) equal var2(1).prior(3)
NOTICE:  var3.prior(5) equal var2.next(1)
 nested_tab_func3 
------------------
                6
(1 row)

select id, flg from nestedtab_test;
 id | flg 
----+-----
 77 |  22
 66 |  33
(2 rows)

--init empty value and assign value to it
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa();
	type type_bb is varray(10) of varchar(10);
	var2 type_bb := type_bb();
begin
	raise notice 'var1.count = %', var1.count; --0
	raise notice 'var2.count = %', var2.count; --0
	raise notice 'var1.first = %', var1.first; --NULL
	raise notice 'var2.last = %', var2.last; --NULL
	raise notice 'var2.exists(1) = %', var2.exists(1); --f
	raise notice 'var1.limit = %', var1.limit; --NULL
	raise notice 'var2.limit = %', var2.limit; --10
	var1.extend;
	var1(1) := 11;
	raise notice 'var1 = %', var1; --11
	raise notice 'var1.count = %', var1.count; --1
	raise notice 'var1.last = %', var1.last; --1
	raise notice 'var1.exists(1) = %', var1.exists(1); --t
end;
/
select nested_tab_func1();
NOTICE:  var1.count = 0
NOTICE:  var2.count = 0
NOTICE:  var1.first = <NULL>
NOTICE:  var2.last = <NULL>
NOTICE:  var2.exists(1) = f
NOTICE:  var1.limit = <NULL>
NOTICE:  var2.limit = 10
NOTICE:  var1 = {11}
NOTICE:  var1.count = 1
NOTICE:  var1.last = 1
NOTICE:  var1.exists(1) = t
 nested_tab_func1 
------------------
 
(1 row)

--if is empty, it will not throw error when delete
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa();
begin
	var1.delete;
	var1.delete(2);
	raise notice 'var1 = %', var1;
end;
/
select nested_tab_func1();
NOTICE:  var1 = {}
 nested_tab_func1 
------------------
 
(1 row)

--if is empty, it will throw error when trim
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa;
begin
	var1 := type_aa();
	var1.trim;
end;
/
select nested_tab_func1();
ERROR:  Subscript beyond count
DETAIL:  An in-limit subscript was greater than the count of a varray or too large for a nested table.
CONTEXT:  PL/hgSQL function collection_trim(nestedtab) line 3 at assignment
SQL statement "CALL var1.trim"
PL/hgSQL function nested_tab_func1() line 7 at CALL
--
--extend is procedure, not is function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22);
begin
	var1 := var1.extend();
end;
/
select nested_tab_func1();
ERROR:  collection_extend(nestedtab) is a procedure
LINE 1: SELECT var1.extend()
               ^
HINT:  To call a procedure, use CALL.
QUERY:  SELECT var1.extend()
CONTEXT:  PL/hgSQL function nested_tab_func1() line 6 at assignment
--
--test empty for nested table function
--
create or replace function nested_tab_func1() return void as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa();
begin
	raise notice 'var1.exists(1) = %', var1.exists(1);
	raise notice 'var1.first = %', var1.first;
	raise notice 'var1.last = %', var1.last;
	raise notice 'var1.count = %', var1.count;
	raise notice 'var1.limit = %', var1.limit;
	raise notice 'var1.prior(0) = %', var1.prior(0);
	raise notice 'var1.next(0) = %', var1.next(0);
end;
/
select nested_tab_func1();
NOTICE:  var1.exists(1) = f
NOTICE:  var1.first = <NULL>
NOTICE:  var1.last = <NULL>
NOTICE:  var1.count = 0
NOTICE:  var1.limit = <NULL>
NOTICE:  var1.prior(0) = <NULL>
NOTICE:  var1.next(0) = <NULL>
 nested_tab_func1 
------------------
 
(1 row)

--
--use collection type as return type
--
drop function nested_tab_func1;
create or replace function nested_tab_func1() return nestedtab as
declare
	type type_aa is table of int;
	var type_aa;
begin
	var := type_aa(11, 22, 33, 44, 55);
	raise notice 'var = %', var;
	raise notice 'var(5) = %', var(5);

	return var;
end;
/
select nested_tab_func1();
NOTICE:  var = {11,22,33,44,55}
NOTICE:  var(5) = 55
 nested_tab_func1 
------------------
 {11,22,33,44,55}
(1 row)

drop function nested_tab_func1;
create or replace function nested_tab_func1() return varray as
declare
	type type_aa is table of int;
	var1 type_aa := type_aa(11, 22, 33, 44, 55);
	type type_bb is varray(10) of type_aa;
	var2 type_bb := type_bb(var1, type_aa(66, 77));
begin
	return var2;
end;
/
select nested_tab_func1();
        nested_tab_func1        
--------------------------------
 {"{11,22,33,44,55}","{66,77}"}
(1 row)

drop function nested_tab_func1;
create or replace function nested_tab_func1() return nestedtab as
declare
	type type_aa is table of int;
	var type_aa := type_aa(11);
begin
	return var(1);
end;
/
select nested_tab_func1();
ERROR:  "11" is invalid, please use correct type
CONTEXT:  PL/hgSQL function nested_tab_func1() while casting return value to function's return type
--collection type can not as common type
drop function nested_tab_func1;
create or replace function nested_tab_func1() return int as
declare
	type type_aa is table of varray;
	var type_aa := type_aa(11);
begin
	return var(1);
end;
/
ERROR:  column type can not is abstract type "varray"
LINE 3:  type type_aa is table of varray;
                                  ^
QUERY:  
declare
	type type_aa is table of varray;
	var type_aa := type_aa(11);
begin
	return var(1);
end;
create or replace function nested_tab_func1() returns int as $$
declare
	id nestedtab;
begin
	return 1;
end; $$language plpgsql;
ERROR:  column type can not is abstract type "nestedtab"
LINE 3:  id nestedtab;
            ^
create table test(id int, flg varray);
ERROR:  column type can not is abstract type "varray"